<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Camera QR Stage</title>
</head>
<body>

<button id="start">start camera</button>
<br><br>

<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<script>
  const startBtn = document.getElementById("start");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  const video = document.createElement("video");
  video.setAttribute("playsinline", "");
  video.autoplay = true;

  let stream = null;
  let stage = "NONE";

  startBtn.onclick = async () => {
    if (stream) return;

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    video.srcObject = stream;

    video.onloadedmetadata = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      requestAnimationFrame(draw);
    };
  };

  function draw() {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const qr = jsQR(imageData.data, canvas.width, canvas.height);

    if (qr && qr.data === "Stage001") {
      stage = "Stage001";
    }

    if (stage === "Stage001") {
      applyHueShift(imageData, 120);
      ctx.putImageData(imageData, 0, 0);
    }

    requestAnimationFrame(draw);
  }

  function applyHueShift(imageData, degrees) {
    const data = imageData.data;
    const angle = degrees * Math.PI / 180;
    const cosA = Math.cos(angle);
    const sinA = Math.sin(angle);

    for (let i = 0; i < data.length; i += 4) {
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];

      data[i]     = r * cosA - g * sinA;
      data[i + 1] = r * sinA + g * cosA;
      data[i + 2] = b;
    }
  }
</script>

</body>
</html>
