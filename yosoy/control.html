<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>YO SOY / CONSOLA MAESTRA</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{ --bg:#0b0b0b; --fg:#9a9a9a; --accent:#00ff9c; --dim:#444; --warn:#ff4444; }
body{ margin:0; background:var(--bg); color:var(--fg); font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; padding:20px; }
h1{ font-size:16px; color:var(--accent); letter-spacing:0.05em; margin-bottom:20px; }

/* GLOBAL CONTROL PANEL */
/* CONSOLA DE MANDO FIX */
.broadcast-panel { border: 1px solid var(--accent); padding: 24px; margin-bottom: 24px; }
.broadcast-grid { display: flex; gap: 40px; justify-content: space-between; }
.control-group { flex: 1; display: flex; flex-direction: column; gap: 15px; }

/* Aggregator Sliders must match Pulse for parity */
input[type=range]::-webkit-slider-runnable-track { height:2px; background:var(--dim); }
input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:14px; height:14px; margin-top:-6px; background:#fff; border-radius:50%; }

.btn-row { display: flex; gap: 1px; margin-top: 24px; }
.btn-row button { height: 48px; border: 1px solid var(--accent); background: none; color: var(--accent); font-family: inherit; cursor: pointer; transition: 0.2s; }
#muteBtn.active { background: #ff4444; color: #fff; border-color: #ff4444; }
#syncBtn.active { background: var(--accent); color: var(--bg); }

/* STUDENT MONITOR */
#grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; }
.node { border: 1px solid var(--dim); padding: 10px; font-size: 10px; opacity: 0.5; }
.node.active { border-color: var(--accent); opacity: 1; }
.node-id { color: var(--accent); display: block; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; }
</style>
</head>
<body>

<h1>YO SOY / CONSOLA DE MANDO (STAGE 2)</h1>

<div class="broadcast-panel">
  <div class="broadcast-grid">
    <div class="control-group">
      <label>GLOBAL Hz: <span id="fV">440</span></label>
      <input type="range" id="f" min="50" max="2000" value="440">
      <label>GLOBAL BPM: <span id="bV">120</span></label>
      <input type="range" id="b" min="1" max="240" value="120">
    </div>
    <div class="control-group">
      <label>GLOBAL ADSR (A/D/S/R)</label>
      <input type="range" id="att" min="0" max="1" step="0.01" value="0.05">
      <input type="range" id="dec" min="0" max="1" step="0.01" value="0.1">
      <input type="range" id="sus" min="0" max="1" step="0.01" value="0.6">
      <input type="range" id="rel" min="0" max="1" step="0.01" value="0.2">
    </div>
  </div>
  
  <div class="btn-row">
    <button id="syncBtn">FORCE SYNC</button>
    <button id="muteBtn" class="mute">FORCE MUTE</button>
  </div>
</div>

<div id="grid"></div>

<script>
const firebaseConfig = { apiKey: "AIzaSyAlLmIKEa5448MbZRtBOhBYsaDXGtts8rY", authDomain: "yo-soy-f0351.firebaseapp.com", projectId: "yo-soy-f0351" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let isSyncing = false;
let isMuted = false;

// UI Handlers
const f = document.getElementById('f'), b = document.getElementById('b'), fV = document.getElementById('fV'), bV = document.getElementById('bV');
const att = document.getElementById('att'), dec = document.getElementById('dec'), sus = document.getElementById('sus'), rel = document.getElementById('rel');
const syncBtn = document.getElementById('syncBtn'), muteBtn = document.getElementById('muteBtn');

f.oninput = () => { fV.innerText = f.value; broadcast(); };
b.oninput = () => { bV.innerText = b.value; broadcast(); };
[att, dec, sus, rel].forEach(el => el.oninput = broadcast);

syncBtn.onclick = () => { isSyncing = !isSyncing; syncBtn.classList.toggle('active'); broadcast(); };
muteBtn.onclick = () => { isMuted = !isMuted; muteBtn.classList.toggle('active'); broadcast(); };

async function broadcast() {
  await db.collection("commands").doc("global").set({
    forceSync: isSyncing,
    forceMute: isMuted,
    tone: {
      freq: +f.value,
      bpm: +b.value,
      adsr: { a: +att.value, d: +dec.value, s: +sus.value, r: +rel.value }
    },
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
}

// Monitor active students
db.collection("students").onSnapshot(snap => {
  const grid = document.getElementById('grid');
  grid.innerHTML = "";
  snap.forEach(doc => {
    const data = doc.data();
    if(!data.tone) return;
    const node = document.createElement('div');
    node.className = `node ${data.online ? 'active' : ''}`;
    node.innerHTML = `<span class="node-id">${data.id}</span>${data.tone.bpm} BPM | ${data.tone.freq}Hz`;
    grid.appendChild(node);
  });
});
</script>
</body>
</html>